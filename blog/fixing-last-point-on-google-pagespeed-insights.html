<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><style>body>*,header span,img{margin:0 auto}@font-face{font-family:Oswald;font-style:normal;font-weight:400;src:local("Oswald Regular"),local("Oswald-Regular"),url(/oswald.woff) format("woff")}h1,h2,h3,h4,h5,h6,header{font-family:Oswald,sans-serif;padding-top:38px;color:#0d1113;line-height:1.2em;text-align:center}img{max-width:100%;height:auto;display:block}h1{opacity:.8;font-size:1.6em}body,html{margin:0;padding:0}body{font:19px Georgia,serif;color:#333;-webkit-font-smoothing:antialiased}p,section nav{line-height:1.4em}body>*{max-width:740px;box-sizing:border-box;padding-left:19px;padding-right:19px}p{padding-top:1em;margin-top:0;margin-bottom:0}article p:first-child{font-size:1.4em;line-height:1.4em;padding-bottom:.2em}header{background:#7b8ad6;color:#FFF;padding:1.6em .4em;font-size:2.4em;line-height:1.2em;text-align:center;max-width:100%;font-weight:400}header span{max-width:640px;display:block;text-shadow:0 3px 0 rgba(0,0,0,.2)}header small{display:block;font-size:.5em;font-family:Georgia,serif;opacity:.8}header img{border-radius:50%;vertical-align:middle;width:40px;height:40px}code,pre{overflow-x:auto;max-width:100%}a{color:#7b8ad6}a:visited{color:#95a1de}section nav{font-size:1.4em}</style><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/favicon.ico"><title>Fixing the last point on Google PageSpeed Insights</title></head><body><header><span>Fixing the last point on Google PageSpeed Insights</span> <small>A blog post by Jesse Luoto</small></header><article><p>If you&#39;ve tried to build your site to 100/100 in the Google PageSpeed Insights, you might have bumped in the following warning:</p><div style="background:#f7f7f7; padding: 12px 12px 9px; font-family: sans-serif; font-size: 14px; margin: 20px 0 15px"><div style="font-size: 1.2em">Leverage browser caching</div><p style="padding-top: 1em"><strong>Setting an expiry date or a maximum age in the HTTP headers for static resources instructs the browser to load previously downloaded resources from local disk rather than over the network.</strong></p><p style="padding-top: 1em">Leverage browser caching for the following cacheable resources:</p><ul style="background-color: #fff;padding-left: 0"><li style="list-style: none; padding: 3px"><a href="http://www.google-analytics.com/analytics.js">http://www.google-analytics.com/analytics.js</a> (2 hours)</li></ul></div><p>As you might want to use GA in your site, the 99/100 PageSpeed score might get frustrating. Especially because Google Analytics team itself has stated <a href="https://code.google.com/p/analytics-issues/issues/detail?id=101">it won&#39;t fix the issue</a>.</p><h1 id="fixing-the-issue">Fixing the issue</h1><p>This is why I created <a href="https://github.com/jehna/ga-lite/">GA-Lite</a>, a small subset of Google Analytics that uses the <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/reference">Google Analytics Measurement Protocol REST API</a>. The library can be easily downloaded from the Github and hosted on your own server, fixing the &quot;Leverage browser caching&quot; warning.</p><p>If you trust me, you can also use the <a href="https://cdn.jsdelivr.net/ga-lite/1.0.0/ga-lite.min.js">a CDN</a> to load the library. This automatically sets the appropriate headers to the script so you can get the remaining GA issue solved.</p><h1 id="how-to-install-">How to install?</h1><p>The easiest way to install the script is to include the CDN version to you HTML code:</p><pre><code class="lang-HTML"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/ga-lite/latest/ga-lite.min.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">var</span> galite = galite || </span></span><span class="hljs-template-variable">{}</span><span class="xml"><span class="actionscript">;
galite.UA = <span class="hljs-string">'UA-XXXXXX'</span>; <span class="hljs-comment">// Insert your tracking code here</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre><p>This adds the library to your webpage and starts sending the page views to the Google Analytics servers.</p><h1 id="why-not-to-just-copy-the-analytics-js-to-my-server-">Why not to just copy the analytics.js to my server?</h1><p>If you&#39;ve done googling like I have, you probably have stumbled to many other solutions. Commonly they suggest that you either download the <code>analytics.js</code> file to your own server or use some proxy in the between.</p><p>Google itself <a href="https://support.google.com/analytics/answer/1032389?hl=en">does not recommend</a> downloading <code>analytics.js</code> to your own server, so they can ensure your analytics data won&#39;t get broken after they update their code.</p><p>If you&#39;d just copy the <code>analytics.js</code> file to your own server, it would potentially break at any minute. This is, because Google makes updates to their code from time to time.</p><p>So if Google changes something, that leaves your website hanging with the <em>old</em> version of the <code>analytics.js</code>, potentially breaking the analytics tracking.</p><h2 id="what-about-a-proxy-">What about a proxy?</h2><p>The next logical step would be to use <a href="http://diywpblog.com/leverage-browser-cache-optimize-google-analytics/">a proxy</a> that keeps up the most current version of the script, but sets the &quot;correct&quot; headers for you.</p><p>This is heavily discouraged for two main reasons:</p><ol><li>Google wants to keep the ownership of the script. So if they make a breaking change, every single <code>analytics.js</code> will be up-to-date within 2 hours. But your proxy will still keep the old script cached for longer times, breaking your site&#39;s analytics.</li><li>Can you really trust an <a href="http://sourceforge.net/projects/schedule-analytics/">outside vendor</a>? Even if they are not evil and inject your script with spam, they could stop updating/serving the script at any time.</li></ol><p>As a rule of thumb, you should not include any code to your website/product that you have not gone through or use a vendor that you don&#39;t trust.</p><p>The good thing about <em>ga-lite</em> is, that anyone can easily go through all the source code and build it themselves. And you can compare the built source code to the one in the CDN and see that they match.</p><h1 id="technical-definition">Technical definition</h1><p>There are a few things why <em>ga-lite</em> has &quot;lite&quot; in its name. Currently the script only tracks the page views and tries to keep the <a href="http://cutroni.com/blog/2012/02/29/understanding-google-analytics-time-calculations/">time spent on page</a>.</p><p>The script first generates a <a href="https://github.com/jehna/ga-lite/blob/c27c9c2698e3d8ddf29bd5a68f412b9e8e901c45/src/ga-lite.js#L9">random identifier</a> for the user and saves it to the <code>localStorage</code> variable.</p><p>It then <a href="https://github.com/jehna/ga-lite/blob/c27c9c2698e3d8ddf29bd5a68f412b9e8e901c45/src/ga-lite.js#L67">sends</a> a <code>pageview</code> event to the Google&#39;s servers with 0.1 second delay after the page has been loaded. The sending is done through a well-documented <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/reference">Analytics Measurement Protocol REST API</a>.</p><p>Since the Google Analytics <a href="http://cutroni.com/blog/2012/02/29/understanding-google-analytics-time-calculations/">uses events</a> to calculate the time spent on page, the script tries to send additional ping to Google&#39;s servers on browser&#39;s <code>unload</code> event, which fires <a href="https://github.com/jehna/ga-lite/blob/c27c9c2698e3d8ddf29bd5a68f412b9e8e901c45/src/ga-lite.js#L74-L84">right after the user closes the page</a>.</p><p>Since sending a regular, blocking request on the <code>unload</code> event is discouraged, <em>ga-lite</em> uses the new <a href="https://github.com/jehna/ga-lite/blob/c27c9c2698e3d8ddf29bd5a68f412b9e8e901c45/src/ga-lite.js#L44">Navigator.sendBeacon</a> API whenever it&#39;s available.</p><h2 id="what-s-next-">What&#39;s next?</h2><p>The above walkthrough pretty much describes the <em>ga-lite</em>&#39;s whole functionality as it is (was) at late 2015.</p><p>Next steps will include that the script will be slowly improved to have more of the features from the full <code>analytics.js</code>, as they are needed by users.</p><p>If you want to request a feature, please <a href="https://github.com/jehna/ga-lite/issues/new">fill in an issue</a>, or fork the repo and create a pull request.</p><p><a href="https://twitter.com/intent/tweet?text=%22Fixing%20the%20last%20point%20on%20Google%20PageSpeed%20Insights%22%20by%20@luotojesse%20https://thejunkland.com/blog/fixing-last-point-on-google-pagespeed-insights.html" class="twittershare" target="_blank">Tweet</a></p><form action="https://script.google.com/macros/s/AKfycbxRbnrX_4N2LPp7P2DIYuVA9BqnZeJPKHZaNedhjakItb9Rxm83/exec" method="POST"><h3>Be the first to know from new&nbsp;blog&nbsp;posts</h3><p>Subscrbe to the mailing list to get priority access to new blog posts!</p><div><input type="email" name="email" placeholder="Your email address"></div><button type="submit">Subscribe!</button></form></article><footer><p>This site was made with &#9825; by Jesse Luoto.</p><p>Header font is <a href="https://www.google.com/fonts/specimen/Oswald">Oswald Regular</a> from Google Fonts</p><nav><a href="/index.html">Blog</a> <a href="/about.html">About</a></nav></footer><script src="https://cdn.jsdelivr.net/ga-lite/latest/ga-lite.min.js" async></script><script src="/scripts.9b58f1c3.js" async></script></body></html>